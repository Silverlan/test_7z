name: Build 7-Zip Format7zF

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SEVENZ_TARBALL_URL: "https://7-zip.org/a/7z2501-src.tar.xz"
      TARBALL_NAME: "7z-src.tar.xz"

    steps:
      - name: Checkout repo (optional)
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y xz-utils build-essential
        shell: bash

      - name: Download 7z source tarball
        run: |
          curl -fsSL "$SEVENZ_TARBALL_URL" -o "$TARBALL_NAME"
          echo "Downloaded $TARBALL_NAME"
        shell: bash

      - name: Extract tarball and determine SEVENZ_ROOT
        id: extract
        run: |
          set -euo pipefail
          mkdir -p sevenz-src

          # Extract the tar.xz into sevenz-src
          tar -xJf "$TARBALL_NAME" -C sevenz-src

          # Find the single top-level directory created by extraction.
          # Use find on the filesystem (avoids tar | head broken-pipe issues).
          top=$(find sevenz-src -maxdepth 1 -mindepth 1 -type d -printf '%P\n' | head -n1 || true)

          if [ -z "$top" ]; then
            echo "Could not find top-level directory under sevenz-src"
            echo "Listing sevenz-src contents:"
            ls -la sevenz-src || true
            exit 1
          fi

          echo "Top-level directory: $top"
          # Export SEVENZ_ROOT for subsequent steps
          echo "SEVENZ_ROOT=sevenz-src/$top" >> $GITHUB_ENV
          echo "SEVENZ_ROOT set to: sevenz-src/$top"
        shell: bash

      - name: Build Format7zF
        run: |
          set -euo pipefail
          echo "SEVENZ_ROOT=$SEVENZ_ROOT"
          TARGET_DIR="$SEVENZ_ROOT/CPP/7zip/Bundles/Format7zF"
          if [ ! -d "$TARGET_DIR" ]; then
            echo "ERROR: expected directory does not exist: $TARGET_DIR"
            echo "Listing $SEVENZ_ROOT:"
            ls -la "$SEVENZ_ROOT" || true
            exit 1
          fi
          cd "$TARGET_DIR"
          echo "PWD: $(pwd)"
          echo "Contents:"
          ls -la

          # Run the requested make
          make -j -f ../../cmpl_gcc.mak
        shell: bash
